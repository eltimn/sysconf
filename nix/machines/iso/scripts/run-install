#!/usr/bin/env bash
set -euo pipefail

# FIXME: turn these on only when using gnome graphical installer
# gsettings set org.gnome.desktop.session idle-delay 0
# gsettings set org.gnome.settings-daemon.plugins.power sleep-inactive-ac-type 'nothing'

section_header() {
  gum style \
    --foreground 212 --border-foreground 212 --border double \
    --align center --width 50 --margin "1 1"  \
    "${1}"
}

if [ "$(id -u)" -eq 0 ]; then
  echo "ERROR! $(basename "$0") should be run as a regular user"
  exit 1
fi

section_header "Sysconf"

if [ ! -d "$HOME/sysconf/.git" ]; then
  echo "Cloning sysconf repo."
  git clone https://github.com/eltimn/sysconf.git "$HOME/sysconf"
  cd "$HOME/sysconf"
  # if the user does not select a branch and closes the script (ctrl-c), sysconf may be left on the wrong branch.
  selected_branch=$(git branch -a --format="%(refname:short)" | gum choose --header="Choose branch to checkout:")
  if [ "${selected_branch}" != "main" ]; then
    git checkout -t "${selected_branch}"
  fi
fi

section_header "Target Host"

TARGET_HOST=$(ls -1 "$HOME/sysconf/nix/machines/" | grep -v iso | gum choose --header="Choose the target host:")
echo "Using host: $TARGET_HOST"

section_header "Disks"

lsblk --nodeps -o name,size,type,serial
cat <<'EOF'

Manual disk setup required.

- Partition + format your disks however you prefer.
- Create filesystems labeled:
  - boot  -> EFI system partition (vfat)
  - nixos -> root partition (ext4)

Then run:
  sudo mount-disks

EOF

gum confirm --default=false "Disks are partitioned/formatted and mounted to /mnt?" || exit 1

section_header "Secrets"

cat <<'EOF'
If this host requires secrets during install (e.g. /run/keys/*),
run prepare-key first so sops/age can decrypt your secrets repo.

- Plug in the USB (or disk) that contains: keys.txt.gpg
- Then run: prepare-key /dev/<device>

EOF

if gum confirm --default=false "Run prepare-key now?"; then
  key_device=$(lsblk -dpno NAME,SIZE,MODEL | gum choose --header="Select the device/partition holding keys.txt.gpg")
  # use first column (device path)
  key_device_path=$(echo "$key_device" | awk '{print $1}')
  prepare-key "$key_device_path"
fi

echo "Generating the hardware config"
# Write hardware config into the host directory (tracked later once back in sysconf)
sudo nixos-generate-config --dir "$HOME/sysconf/nix/machines/$TARGET_HOST" --no-filesystems

echo "Config saved in $HOME/sysconf/nix/machines/$TARGET_HOST"

section_header "Install OS"

gum confirm --default=false "You are about to start the OS installation. Do you want to continue?" || exit 1

sudo nixos-install --no-root-passwd --flake "$HOME/sysconf#$TARGET_HOST"

# copy the sysconf repo into the new system for future reference
sudo mkdir -p /mnt/home/nelly
sudo cp -r "$HOME/sysconf" /mnt/home/nelly

# Afterwards: set password according to the manual, then create an ssh key:
# ssh-keygen -t ed25519 -C "your_email@example.com"
