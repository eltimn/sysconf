#!/usr/bin/env bash

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
JSON_DIR="$HOME/.local/state/init-project"
JSON_FILE="${JSON_DIR}/nix-templates.json"
GENERATOR_SCRIPT="${SCRIPT_DIR}/generate-templates.py"

# Check dependencies
check_dependencies() {
    local deps=("python3" "jq" "gum" "direnv")
    local missing=()

    for dep in "${deps[@]}"; do
        if ! command -v "$dep" &> /dev/null; then
            missing+=("$dep")
        fi
    done

    if [[ ${#missing[@]} -gt 0 ]]; then
        echo "Error: Missing required dependencies: ${missing[*]}" >&2
        echo "Install with: nix-env -iA nixpkgs.{${missing[*]}}" >&2
        exit 1
    fi
}

# Create JSON directory if needed
if [ ! -d "$JSON_DIR" ]; then
  mkdir -p "$JSON_DIR"
fi

# Function to generate JSON file
generate_json() {
    local force_flag="${1:-}"

    if [[ ! -f "$GENERATOR_SCRIPT" ]]; then
        echo "Error: Generator script not found at $GENERATOR_SCRIPT" >&2
        exit 1
    fi

    # Build command arguments for Python script
    local args=("python3" "$GENERATOR_SCRIPT")
    args+=("-o" "$JSON_FILE")
    if [[ "$force_flag" == "--force" ]]; then
        args+=("-f")
    fi

    # Execute Python script directly
    "${args[@]}"
}

# Function to check if JSON exists and generate if needed
check_json() {
    if [[ ! -f "$JSON_FILE" ]]; then
        echo "Template file not found. Generating..."
        generate_json
    fi
}

# Function to parse JSON and extract templates
parse_templates() {
    jq -r '.templates[] | "\(.ref)|\(.name) - \(.description) (\(.source))"' "$JSON_FILE"
}

# Parse command line arguments
UPDATE_MODE=false
while [[ $# -gt 0 ]]; do
    case $1 in
        --update|-u)
            UPDATE_MODE=true
            shift
            ;;
        --help|-h)
            echo "Usage: $(basename "$0") [OPTIONS]"
            echo ""
            echo "Initialize a new project using nix flake templates."
            echo ""
            echo "Options:"
            echo "  --update, -u    Force update the templates list from sources"
            echo "  --help, -h      Show this help message"
            echo ""
            echo "The script uses a JSON file (nix-templates.json) to store template information."
            echo "If the file doesn't exist, it will be automatically generated."
            exit 0
            ;;
        *)
            echo "Unknown option: $1"
            echo "Use --help for usage information"
            exit 1
            ;;
    esac
done

# Check dependencies before proceeding
check_dependencies

# Handle update mode
if [[ "$UPDATE_MODE" == true ]]; then
    echo "Updating templates from sources..."
    generate_json "--force"
    echo "Templates updated successfully!"
    exit 0
fi

# Check if JSON exists (auto-generate if not)
check_json

# Parse templates from JSON
declare -a TEMPLATES=()
while IFS= read -r line; do
    TEMPLATES+=("$line")
done < <(parse_templates)

if [[ ${#TEMPLATES[@]} -eq 0 ]]; then
    echo "Error: No templates found in $JSON_FILE" >&2
    exit 1
fi

# Extract just the display names for gum
declare -a display_names=()
for template in "${TEMPLATES[@]}"; do
    display_names+=("${template#*|}")
done

# Use gum filter to search and select a template
selected_display=$(printf '%s\n' "${display_names[@]}" | gum filter --placeholder="Type to filter templates...")

# Find the corresponding template URL
selected_template=""
for template in "${TEMPLATES[@]}"; do
    if [[ "${template#*|}" == "$selected_display" ]]; then
        selected_template="${template%|*}"
        break
    fi
done

if [[ -z "$selected_template" ]]; then
    echo "No template selected"
    exit 1
fi

# Run nix flake init
echo "Initializing project with template: $selected_template"
if ! nix flake init --template "$selected_template"; then
    echo "Error: Failed to initialize project with template" >&2
    exit 1
fi

# Check if .envrc exists, if not create it
if [[ ! -f ".envrc" ]]; then
    echo "Creating .envrc file..."
    echo "use flake" > .envrc
fi

# Check if .gitignore exists, if not create it
if [[ ! -f ".gitignore" ]]; then
    echo "Creating .gitignore file..."
    cat > .gitignore << 'EOF'
.direnv
.envrc
result/
EOF
fi

# Run direnv allow
echo "Running direnv allow..."
direnv allow

echo "Project initialized successfully!"
